name: Auto merge dependabot

on:
  workflow_run:
    workflows: [ 'Pull request' ]
    types: [ completed ]
    branches:
      - 'dependabot/**'

jobs:
  approve-pr:
    name: 🤖️ Auto merge dependency updates
    if: github.actor == 'dependabot[bot]' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_BRANCH: ${{ github.event.workflow_run.head_branch }}
      GH_REPO: ${{ github.repository }}
    steps:
      - name: 🟢 Approve PR
        run: gh pr review $PR_BRANCH --approve

      - name: Enable auto-merge for Dependabot PRs
        run: gh pr merge $PR_BRANCH --auto --squash

  publish-test-result:
    name: 📊 Publish test results
    if: github.actor == 'dependabot[bot]' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: 🧩 Fetch artifact (unit test)
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: "Pull request"
          name: unit-test-results
          run_id: ${{ github.event.workflow_run.id }}

      - name: 📊 Publish results
        uses: EnricoMi/publish-unit-test-result-action@v1
        with:
          commit: ${{ github.event.workflow_run.head_sha }}
          files: "**/build/test-results/test/TEST-*.xml"
