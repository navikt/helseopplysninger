name: Auto merge PR

on:
  workflow_run:
    workflows: [ 'Pull request' ]
    types: [ completed ]
    branches:
      - 'dependabot/**'

jobs:
  test:
    name: ğŸ§ª test
    if: github.actor == 'dependabot[bot]' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          java-version: 16
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸª² Run gradle test
        run: ./gradlew test --no-daemon

      - name: ğŸ”‘ Generate team token
        uses: navikt/github-app-token-generator@v1
        id: gen-token
        with:
          private-key: ${{ secrets.HOPS_CI_TOOL_PRIVATE_KEY }}
          app-id: ${{ secrets.HOPS_CI_TOOL_APP_ID }}

      - name: ğŸ“Š Publish results with dorny
        uses: dorny/test-reporter@v1.5.0
        with:
          name: junit tests
          path: "**/build/test-results/test/TEST-*.xml"
          reporter: java-junit
          token: ${{ steps.gen-token.outputs.token }}

  approve:
    name: ğŸ¤–ï¸ approve
    if: github.actor == 'dependabot[bot]' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: ğŸŸ¡ï¸ Dependabot metadata
        uses: dependabot/fetch-metadata@v1.1.1
        id: metadata
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”´ Stop auto merge
        if: ${{ steps.metadata.outputs.update-type == 'version-update:semver-major' }}
        run: |
          echo "Major version is not enabled for auto merge"
          exit 1

      - name: ğŸ”‘ Generate team token
        uses: navikt/github-app-token-generator@v1
        id: gen-token
        with:
          private-key: ${{ secrets.HOPS_CI_TOOL_PRIVATE_KEY }}
          app-id: ${{ secrets.HOPS_CI_TOOL_APP_ID }}

      - name: ğŸŸ¢ï¸ Request a merge from dependabot
        run: gh pr comment $PR_BRANCH --body "@dependabot squash and merge"
        env:
          GITHUB_TOKEN: ${{ steps.gen-token.outputs.token }}
          PR_BRANCH: ${{ github.head_ref }}